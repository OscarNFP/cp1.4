pipeline{
    // Cualquier agente disponible para ejecutar el pipeline
    agent any

    // Evitar el checkout automático del código fuente
    options { skipDefaultCheckout() }

    stages{

        // Etapa para obtener el código fuente
        stage('GET CODE'){
            steps{
                checkout scm
                sh '''
                    echo $WORKSPACE
                    whoami
                    hostname
                    echo "Descargando configuración de despliegue SAM..."
                    wget https://raw.githubusercontent.com/OscarNFP/todo-list-aws-config/refs/heads/staging/samconfig.toml
                '''
                // Podemos guardar el código fuente y ficheros ocultos concretros o bien todos los ficheros ocultos
                // usando la opción "useDefaultExcludes: false"
                stash name:'code', includes:'**', useDefaultExcludes: false
                cleanWs()
            }
        }

        // Etapa de test de código estático y seguridad en paralelo
        stage('Test'){
            parallel{

                // Etapa de pruebas de código estático
                stage('Static'){
                    agent { label 'agent1' }
                    steps{
                        unstash 'code'
                        sh '''
                            echo ${WORKSPACE}
                            whoami
                            hostname
                            flake8 --exit-zero --format=pylint src > flake8.out
                        '''
                        // Configuro Quality Gates de apartados anteriores pero no se usarán
                        recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')],
                                     qualityGates: [
                                        [threshold: 8, type: 'TOTAL', unstable: true],
                                        [threshold: 10, type: 'TOTAL', unstable: false]
                                     ]
                    }
                    post {
                        always {
                            cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                        }
                    }
                }

                // Etapa de pruebas de seguridad
                stage('Security') {
                    agent { label 'agent1' }
                    steps {
                        unstash 'code'
                        sh '''
                            echo ${WORKSPACE}
                            whoami
                            hostname
                            bandit -r ./src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
                        '''
                        // Configuro Quality Gates de apartados anteriores pero no se usarán
                        recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')],
                                     qualityGates: [
                                        [threshold: 2, type: 'TOTAL', unstable: true],
                                        [threshold: 4, type: 'TOTAL', unstable: false]
                                     ]
                    }
                    post {
                        always {
                            cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                        }
                    }
                }
            }
        }

        // Etapa de despliegue SAM
        stage('Deploy'){
            steps{
                unstash 'code'
                sh '''
                    echo $WORKSPACE
                    whoami
                    hostname
                    sam validate --region us-east-1
                    sam build
                    sam deploy --config-env staging --resolve-s3 --no-fail-on-empty-changeset
                '''

                // Guardo el resultado en un fichero de texto
                // para luego poder usarla en la siguiente etapa.
                // Finalmente se eliminará del WorkSpace 
                sh '''
                    aws cloudformation describe-stacks \
                        --stack-name todo-list-aws-staging \
                        --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                        --region us-east-1 --output text > api_url.txt
                '''

                stash name: 'api-url', includes: 'api_url.txt'
            }
            post {
                always {
                    cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                }
            }
        }
        
        // Etapa de pruebas de integración
        stage('Rest'){
            agent { label 'agent1' }
            steps{
                unstash 'code'
                unstash 'api-url'

                sh '''
                    echo $WORKSPACE
                    whoami
                    hostname
                    BASE_URL=$(cat api_url.txt)
                    export BASE_URL
                    pytest --junitxml=result-rest.xml test/integration
                '''
                junit 'result-rest.xml'
            }
            post {
                always {
                    cleanWs(deleteDirs: true, disableDeferredWipeout: true)
                }
            }
        }

        // Etapa de promoción a producción
        stage('Promote'){
            steps{
                unstash 'code'
                withCredentials([string(credentialsId: 'github-token', variable: 'GIT_TOKEN')]) {
                sh '''
                    echo $WORKSPACE
                    whoami
                    hostname
                    
                    git config user.email "jenkins@oscarnappo.es"
                    git config user.name "Jenkins CI"

                    git config credential.helper 'cache --timeout=30'
                    printf "protocol=https\nhost=github.com\nusername=x-access-token\npassword=${GIT_TOKEN}\n\n" | git credential approve

                    # Traemos todas las referencias remotas
                    git fetch origin master

                    # Creamos / reseteamos master desde origin/master
                    git checkout -B master FETCH_HEAD

                    # Declaramos específicamente el driver ours para evitar conflictos (si existen) y mantener los ficheros Jenkinsfile de master
                    git config merge.ours.driver true
    
                    # Merge desde develop
                    git merge origin/develop --no-ff -m "Merge automático desde pipeline"

                    # Push a master
                    git push origin master
                '''
                }
            }
        }
    }

    post { 
        always { 
            cleanWs()
        } 
    }
}
