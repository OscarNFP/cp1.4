pipeline{
    // Cualquier agente disponible podrá ejecutar el pipeline
    agent any

    // Estapas del pipeline
    stages{

        //Etapa para obtener el código fuente
        stage('Get Code'){
            // Realizamos el checkout del SCM configurado en Jenkins
            steps{
                checkout scm
                sh '''
                echo "Descargando configuración de despliegue SAM..."
                wget https://raw.githubusercontent.com/OscarNFP/todo-list-aws-config/refs/heads/staging/samconfig.toml
                echo $WORKSPACE
                '''
            }
        }
        
        // Etapa de análisis estático de código
        stage('Flake8') {
            steps {
                sh '''
                    flake8 --exit-zero --format=pylint src >flake8.out
                '''   
                recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 8, type: 'TOTAL', unstable: true], [threshold: 10, type: 'TOTAL', unstable: false]]
            }
        }
        
        // Etapa de pruebas de seguridad
        stage('Security') {
            steps {
                sh '''
                    bandit -r ./src -f custom -o bandit.out --msg-template "{abspath}:{line}: [{test_id}] {msg}"
                '''
                recordIssues tools: [pyLint(name: 'Bandit', pattern: 'bandit.out')], qualityGates: [[threshold: 2, type: 'TOTAL', unstable: true], [threshold: 4, type: 'TOTAL', unstable: false]]
            }
        }
        
        //Etapa de despliegue SAM
        stage('Deploy'){
            steps{
                sh '''
                    sam build
                    sam validate --region us-east-1
                    sam deploy --config-env staging --resolve-s3 --no-fail-on-empty-changeset
                '''
            }
        } 

        // Etapa de pruebas de integración
        stage('Rest'){
            steps{
                sh '''
                    # Obtenemos la URL base del API Gateway desde los outputs del stack de CloudFormation
                    BASE_URL=$(aws cloudformation describe-stacks \
                    --stack-name todo-list-aws-staging \
                    --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                    --region us-east-1 --output text)
                    export BASE_URL
                    pytest --junitxml=result-rest.xml test/integration
                '''
                junit 'result-rest.xml'
            }
        }
        
        // Etapa de promoción a master 
        stage('Promote'){
            steps{

                withCredentials([string(credentialsId: 'github-token', variable: 'GIT_TOKEN')]) {
                sh '''
                    git config user.email "jenkins@oscarnappo.es"
                    git config user.name "Jenkins CI"

                    git config credential.helper 'cache --timeout=30'
                    printf "protocol=https\nhost=github.com\nusername=x-access-token\npassword=${GIT_TOKEN}\n\n" | git credential approve

                    # Aseguramos que tenemos la última versión de master
                    git fetch origin master
    
                    # Cambiamos a master
                    git checkout -B master origin/master

                    # Hacemos merge de la rama develop
                    git merge origin/develop --no-ff -m "Merge automático desde pipeline"
                    

                    # Push a master usando credenciales almacenadas en Jenkins Secrets
                    git push origin master
                '''

                }
            }
        }
    }
    post { 
        always { 
            cleanWs()
        } 
    }
}