pipeline{
    // Cualquier agente disponible podrá ejecutar el pipeline
    agent any

    // Estapas del pipeline
    stages{

        //Etapa para obtener el código fuente
        stage('Get Code'){
            // Realizamos el checkout del SCM configurado en Jenkins
            steps{
                checkout scm
                sh 'echo $WORKSPACE'
            }
        }
        
        //Etapa de despliegue SAM
        stage('Deploy'){
            steps{
                sh '''
                    sam build
                    sam validate --region us-east-1
                    sam deploy
                '''
            }
        } 

        stage('Rest'){
            steps{
                sh '''
                    # Obtenemos la URL base del API Gateway desde los outputs del stack de CloudFormation
                    BASE_URL=$(aws cloudformation describe-stacks \
                    --stack-name todo-list-aws \
                    --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' \
                    --region us-east-1 --output text)
                    echo "La URL base de la API es: $BASE_URL"
                    pytest --junitxml=result-rest.xml pytest -m test/integration
                '''
                junit 'result-rest.xml'
            }
        }

//Por aquí me quedé. Hay que revisarlo
        stage('Promote'){
            steps{
                //build job: 'PIPELINE-FULL-CD'
                // mergeo a master con gitignore de JENKINSFILE para que no machaque el pipeline de CI en el reto 2 con el CD


                withCredentials([string(credentialsId: 'github-token', variable: 'GIT_TOKEN')]) {
                sh '''
                    git config user.email "jenkins@oscarnappo.es"
                    git config user.name "Jenkins CI"

                    # Aseguramos que tenemos la última versión de master
                    git fetch origin master
    
                    # Cambiamos a master
                    git checkout master
    
                    # Hacemos merge de la rama develop
                    git merge origin/develop --no-ff -m "Merge automático desde pipeline"
    
                    # Push a master usando credenciales
                    git push origin master
                '''
            }
        }
    }
}